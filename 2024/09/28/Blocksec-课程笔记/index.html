<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Blocksec 课程笔记 | DravenLu</title><meta name="keywords" content="web3,安全,笔记"><meta name="author" content="Dispa1r"><meta name="copyright" content="Dispa1r"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="BlockSec 区块链安全课程学习笔记还没写完, 最近没空搞, 先传一下先说下我的backgroud哈, 我对web3的生态和基础设施都有一定了解, 在near生态参与开发过DeFi项目和数据索引项目, 因此可能课程中比较基础的知识会直接略过， 本文是在学习BlockSec的一些学习笔记, 里面也会有一些课上内容的拓展研究, 多图预警!!! 第一节 账号与交易原来用Hardhat已经算是老古董了">
<meta property="og:type" content="article">
<meta property="og:title" content="Blocksec 课程笔记">
<meta property="og:url" content="https://dispa1r.github.io/2024/09/28/Blocksec-%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="DravenLu">
<meta property="og:description" content="BlockSec 区块链安全课程学习笔记还没写完, 最近没空搞, 先传一下先说下我的backgroud哈, 我对web3的生态和基础设施都有一定了解, 在near生态参与开发过DeFi项目和数据索引项目, 因此可能课程中比较基础的知识会直接略过， 本文是在学习BlockSec的一些学习笔记, 里面也会有一些课上内容的拓展研究, 多图预警!!! 第一节 账号与交易原来用Hardhat已经算是老古董了">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg">
<meta property="article:published_time" content="2024-09-27T16:49:27.000Z">
<meta property="article:modified_time" content="2024-09-27T17:01:15.702Z">
<meta property="article:author" content="Dispa1r">
<meta property="article:tag" content="web3">
<meta property="article:tag" content="安全">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://dispa1r.github.io/2024/09/28/Blocksec-%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Blocksec 课程笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-28 01:01:15'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://lh3.googleusercontent.com/WO1GMB2JeMcJnRdp8gthoxpF_pLHnceekNZdlqYBcwoArMMxnEVFxpytRjsXI-oJFR3BoepLBPGes1MO6VafBNwWxgRzIBMw1YcVjw=s0" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">DravenLu</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Blocksec 课程笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-09-27T16:49:27.000Z" title="发表于 2024-09-28 00:49:27">2024-09-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-09-27T17:01:15.702Z" title="更新于 2024-09-28 01:01:15">2024-09-28</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Blocksec 课程笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="BlockSec-区块链安全课程学习笔记"><a href="#BlockSec-区块链安全课程学习笔记" class="headerlink" title="BlockSec 区块链安全课程学习笔记"></a>BlockSec 区块链安全课程学习笔记</h1><p>还没写完, 最近没空搞, 先传一下<br>先说下我的backgroud哈, 我对web3的生态和基础设施都有一定了解, 在near生态参与开发过DeFi项目和数据索引项目, 因此可能课程中比较基础的知识会直接略过， 本文是在学习<code>BlockSec</code>的一些学习笔记, 里面也会有一些课上内容的拓展研究, 多图预警!!!</p>
<h2 id="第一节-账号与交易"><a href="#第一节-账号与交易" class="headerlink" title="第一节 账号与交易"></a>第一节 账号与交易</h2><p>原来用<code>Hardhat</code>已经算是老古董了, 记得之前在<code>Aurora</code>上开发空投项目的时候还是用的<code>Hardhat</code>来着, 得试试新框架了 </p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_9326796a968b2012b65c6e842d9db0d3.png" alt=""></p>
<p>这个<code>phalcon fork</code>还挺有意思的, 可以从主网某个区块高度fork出一条当测试链, 不知道效率咋样, 之前在near上开发的时候做测试确实很麻烦的, 创建各种账户地址之后, 需要去结点里取合约状态再patch进去, 尤其测试复杂应用的时候需要填好几个和合约, near的普通rpc结点拉取状态还有大小限制, 超过limit就得去archive结点取, archive结点资源又很紧张…不知道现在解决了没</p>
<p>搜索一下eth fork test, 可以发现刚刚提到的foundry的forge也有类似的功能, 不知道这个产品有什么特别的优势地方, 可能要深度使用才能发现</p>
<p>这章主要还是介绍的一些基础概念,没什么好记录的</p>
<h2 id="第二节-智能合约"><a href="#第二节-智能合约" class="headerlink" title="第二节 智能合约"></a>第二节 智能合约</h2><p>EOA地址和合约地址都可以部署智能合约, 并且会通过某种方式计算出下一个要部署的合约地址</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_6deb054824e661d5f36e962a2939519e.png" alt=""></p>
<p>第一种合约地址计算方式是<code>CREATE</code>, 优点是可被提前预知, 缺点是无法再重复生成之前部署过的合约地址, 因为合约地址计算依赖账户的nonce, 部署合约本身是一笔交易会修改nonce, nonce变了就无法生成之前的地址了</p>
<p>最新的地址计算方式使用<code>CREATE2</code>, 地址计算只涉及到合约代码的哈希,因此可以在不修改合约内容的情况下部署到同一个合约地址</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_71a9dfc280ee0034f65ba62cca0b8af6.png" alt=""></p>
<p>可以看一下前一段时间使用create2碰撞地址钓鱼的example, 一般攻击者会使用<a target="_blank" rel="noopener" href="https://vanity-eth.tk/">vanity-eth</a> 碰撞出</p>
<p>混用create2和create创建合约地址可能带来一定安全隐患,合约B如果代码不变的话想要创建出不同的合约地址C会不生效,同一个地址C可以在不同的时刻部署不同的合约代码,课程中提出的对应的攻击案例: <a target="_blank" rel="noopener" href="https://learnblockchain.cn/article/5916">https://learnblockchain.cn/article/5916</a> , 攻击者的交易: <a target="_blank" rel="noopener" href="https://openchain.xyz/trace/ethereum/0x3274b6090685b842aca80b304a4dcee0f61ef8b6afee10b7c7533c32fb75486d">https://openchain.xyz/trace/ethereum/0x3274b6090685b842aca80b304a4dcee0f61ef8b6afee10b7c7533c32fb75486d</a> ,大概的trick和课程中说的基本一致</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_60435918adaa5a12497e4bfbee1926f2.png" alt=""></p>
<p>写个最简单demo的话差不多就是下面这样</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_3c172a66b4620c3dc4b82cd95fb5e780.png" alt=""></p>
<p>这个点之前不是很清楚,evm的memory中没有os来管理内存地址,因此需要一个指针指向当前可用的内存偏移,这个指针就是存在了0x40的地方</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_bd87785ba267f613e3e0878bec2a53b7.png" alt=""></p>
<p>代理合约可用通过delegateCall实现,好处就是可以保证合约的可升级行,感觉目前大部分正规项目都是采用了代理合约的,也就是修改对用户透明(当然也带来了风险,可能被偷偷植入后门),安全与便携不可兼得</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_6962b1b8d99c9479ac91c59bc8d12a06.png" alt=""></p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_00979c96f32e4f02195b30e33031622e.png" alt=""></p>
<p>如果是多层合约调用,根据是否传递异常有两种调用方式,low-level call并不会对失败交易做revert, </p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_d53429e92e40514de6daf70b2ce22467.png" alt=""></p>
<p>第二个案例,由于实现合约更改了storage布局,从而导致精度计算错误被攻击,因此代理合约和实现合约的存储布局必须保证完全一致</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_5b4d7d748407110f600096af7aaf4bc9.png" alt=""></p>
<p>第三个案例讲了UUVP攻击,由于实现合约的状态信息是没有意义的,因此constructor函数也没有意义,在实现合约中会被改成普通的init函数,然后使用delegate call去调用,因此往往调用init函数的账户会变成合约owner,如果项目方在部署实现合约后忘记调用init或者被抢先调用init,就会导致owner权限被窃取,虽说拿到的状态没有意义,但是可以通过调用updateAndCall函数自毁合约,使proxy合约被锁死彻底失效, 对应真实案例: <a target="_blank" rel="noopener" href="https://medium.com/immunefi/wormhole-uninitialized-proxy-bugfix-review-90250c41a43a">wormhole未初始化攻击</a></p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_545bd71b32353628ad3014d446502a28.png" alt=""></p>
<p>最后一个案例,就是之前提到的tornado cash治理攻击, 攻击者通过先发起正常提案， 在DAO投票通过之后再利用上面的<code>CREATE</code> 和 <code>CREATE2</code> 混用技巧在不修改投票通过的指定合约地址的前提下更改合约内容， 本来社区中对这种create2创建出的合约地址应该保留高度警惕的，同时应该对合约中的自毁函数保持警惕</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_4b004cd3cd522cdfa2103073fc92916c.png" alt=""></p>
<h2 id="第三节课-合约与安全概念"><a href="#第三节课-合约与安全概念" class="headerlink" title="第三节课 合约与安全概念"></a>第三节课 合约与安全概念</h2><p>课程上来先介绍了一些学习资源,mark</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_54f38211612d8233a2a59d27a73e366e.png" alt=""></p>
<p>从一个high level的角度审视区块链安全</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_d08e1d103c1a9dcfad13a8b2a1f8558b.png" alt=""></p>
<p>一些工具(介绍了phalcon explorer)</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_252aa495475905cbdc4277d9fd5cdeab.png" alt=""></p>
<p>感觉block sec的学术背景确实很强啊,经常贴的是一些顶会论文的链接,确实很专业,下面是对区块链攻击的一些分类</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_e5bc4f8ecf46724027b2c3d74b67004e.png" alt=""></p>
<p>终于开始讲案例了,还是从最最最经典的溢出开始,继续鞭尸beautiful token</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_728a5284529f2795a14b9a1dfbd14144.png" alt=""></p>
<p>编译器版本在0.8之后默认使用了safemath,溢出的攻击基本上很少了,但是还是需要小心为了节省gas把代码uncheck了</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_ae4eb8a8f10850a6efdca3c14785eb86.png" alt=""></p>
<p>用了安全库就一定安全吗,不一定,以下图为例,safecast会在整数溢出时revert交易,这就造成了dos攻击,合约无法继续进行(场景:u32存时间、游戏参与人数等)</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_20b9f86a8892f35546814938e52d67d0.png" alt=""></p>
<p>使用lowlevel call时输入校验不充分可能导致很多攻击,下面是今年的一些案例</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_9226aeb4c247bd7b53c57be698fd29b4.png" alt=""></p>
<p>delegate call使用不当导致的问题</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_efbf31f7d4a7c34e3a878d270d2dd70d.png" alt=""></p>
<p>一般来说通过账户的code length去判断账户是否为合约地址,但是在constructor函数里,codelength一直是0,从而导致这个防护失效了,黄皮书里还真是有很多trick, openzeppelin中实现了一个判断合约账户的函数,对合约的不同状态都做了详细的判断</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_c2010df882e2abe151be20e31939d6c8.png" alt=""></p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_11dd5d3bd4f97f2647207b6d8b073740.png" alt=""></p>
<p>Flurry Finance Hack攻击用了一个trick,在EOA地址和合约地址之间左右切换以实现最大收益,想深入学习这个案例发现知识空白很多,深刻认识到了和这种顶尖黑客的差距之大…</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_05d8ef1f6b58eb13c56d5d5bbf837e2a.png" alt=""></p>
<h2 id="第四节课"><a href="#第四节课" class="headerlink" title="第四节课"></a>第四节课</h2><p>好家伙上来就是顶会论文, 看看学术界怎么anti重入攻击的,首先介绍下可重入的概念, 没记错的话linux内核中分别提供了很多api的可重入和不可重入版本,重入和线程安全是不太一样的,很多人容易搞混, 很经典的就是malloc是线程安全的却是不可重入的,在我的理解中加入一个函数被中断打断,同时中断处理中又调用了这个函数,如果这个场景下能保证安全的话那就是可重入的,线程安全则是在多线程情况下不会出现一些资源竞争的情况</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_fe86f57a62464833bbb02d2e80e23b5c.png" alt=""></p>
<p>最简单的转账调用,如果转出的地址是合约账户的话则会触发fallback,在fallback中则可再次调用转账函数,这样就完成了一次最简单的重入攻击</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_b696ec536be89cb2ec774d6cc2b13b99.png" alt=""></p>
<p>为了在一定程度上避免重入, solidty在0.6之后提供了receive函数用于处理收到ETH之后的回调函数, 具体两者之间的关系可以看<a target="_blank" rel="noopener" href="https://www.pangzai.win/%E3%80%90solidity%E3%80%91fallback%E5%92%8Creceive%E7%9A%84%E7%94%A8%E6%B3%95/">这里</a>, 同时使用Transfer也在一定程度上避免重入攻击, 因为transfer有一定的gas限制, 重入攻击涉及到多次合约调用会很快消耗掉gas</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_04df6c3cb3fe2cdfc71c8757ec04786b.png" alt=""></p>
<p>随着安全的进步,攻击手段也被迫逐渐升级,出现了跨合约重入、跨函数重入已经只读重入,这些都需要自己去补充读一下</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_b5d5f0920f8f9e19f3f85cbfec0456b4.png" alt=""></p>
<p>后面介绍了一些攻击的case,经典重入的攻击就不做笔记了,可以看一下新形态的read only的重入攻击,从下面简单的case来看,其实与经典重入没什么区别,都是利用了合约状态更新的延迟导致的状态不一致,只不过这里只是读取某个值用来操纵价格之类的,但是感觉这种情况基本上是不可避免的…业务场景里应该会经常出现</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_22bafdb656a6425f3ae3602646012a53.png" alt=""></p>
<p>看看链接中说的出现readonly reentrany会出现的条件: 一个状态,一个会修改这个状态的外部调用,另一个依赖这个状态的外部调用</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_5c3700cb664f9f971b85e227c4808350.png" alt=""></p>
<p>看一个更接近实战的例子,带入上面的三个条件, state就是每个地址的balance, 一个会修改状态的调用就是withdraw函数,totalSupply会在burn之后更新, balance会在最下面的transfer更新,假设更新没完成就有调用了getSharePrice函数,就会拿到不正确的价格(因为balance还没有更新),因此攻击者可以一边withdraw代币一边从使用了这个getSharePrice函数的dapp中获益</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_cb6f132228cb1a0bc192c840c5c5a69a.png" alt=""></p>
<p>然后真实案例是对Sentiment这个借贷协议的攻击, 可以看一下下图,也是在调用BalanceChange之后再更新的Balance,符合上面所说的read only reentrancy的条件, 具体的攻击者交易可以用<code>Phalcon Explorer</code>查看, 地址在<a target="_blank" rel="noopener" href="https://explorer.phalcon.xyz/tx/arbitrum/0xa9ff2b587e2741575daf893864710a5cbb44bb64ccdc487a100fa20741e0f74d?line=215">这里</a></p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_febe07b1bd9ffca1653993e8da0436e6.png" alt=""></p>
<p>如何对抗重入</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_4c3e913b42ed5320b555d21640cc9a50.png" alt=""></p>
<h2 id="第五节-DEX与DEX安全"><a href="#第五节-DEX与DEX安全" class="headerlink" title="第五节 DEX与DEX安全"></a>第五节 DEX与DEX安全</h2><p>前几章节讲了一些比较general的漏洞, 后面的DEX安全章节则会根据不同DeFi协议去进行区别分析</p>
<p>DEX也就是去中心化交易所, 主要有两种实现方式, 订单簿与自动化做市商,</p>
<p>LOB</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_c6c88a1736a94ca2375ec8c6478643d3.png" alt=""></p>
<p>AMM</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_a8b9f5dc2ef38546f1ad6ed3faf4edf3.png" alt=""></p>
<p>AMM之前的简单原理也介绍过, 下面还是看一下最经典的uniswap的乘积恒定原理</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_1fe2ff23027b6a844852846d7af83c2b.png" alt=""></p>
<p>简单来说乘积很定原理的k值是有一开始添加LP时添加的两个代币的数量决定的, 后续的交易中只要不涉及LP流动性的添加与撤走k保持不变, 并且后续添加LP时也需要根据当前的价格来添加, 但是依旧会影响k值</p>
<p>至于上面的乘积公式中的997, 则是因为uniswap每笔交易需要百分之0.3的手续费</p>
<blockquote>
<p>在课程中提到了所谓的课后作业– impermanent loss(无常损失), 首先你需要知道你添加流动性之后得到了一定比例的share, 这个share代表着你的资产占流动池中的总资产的比例, 假设池子中有2个eth和100个usdt且你的share份额占总份额的百分之10, 那么你在撤走流动性时会得到0.2个eth和10个usdt, 假设在此期间eth的价格产生巨大波动(在web3那就是家常便饭), 那么很可能你添加流动性的价值会小于你撤走流动性时的价值, 这部分损失就叫无常损失, 无常损失一般会通过给予流动性提供者一定的手续费奖励来对冲, <a target="_blank" rel="noopener" href="https://academy.binance.com/en/articles/impermanent-loss-explained">参考链接</a> 点这里</p>
</blockquote>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_9044dd3b3de295ee033a695715625410.png" alt=""></p>
<p>spot价格是指在流动性池创建之初的币价，也就是 x/y， effective价格是指真正在swap时根据池子中比例计算出的价格，也就是 k/x， 而这两者之间的价格差距占比则称为滑点，流动性越高的池子滑点越低，因此大部分价格操纵的攻击事件都发生在流动性不足的池子里</p>
<p><img src="https://hackmd.summershrimp.com/uploads/upload_86a6d5a5056bc806db7b0bbc95dfeddc.png" alt=""></p>
<p>另一种AMM模型则称为Balancer，</p>
<h2 id="补充章节"><a href="#补充章节" class="headerlink" title="补充章节"></a>补充章节</h2><p>这一章主要介绍一些web3无关的攻击手段, 更接近web2，下面这些内容会在Part2展示 </p>
<h4 id="BGP-hijacking"><a href="#BGP-hijacking" class="headerlink" title="BGP hijacking"></a>BGP hijacking</h4><h4 id="supply-chain-poisoning"><a href="#supply-chain-poisoning" class="headerlink" title="supply chain poisoning"></a>supply chain poisoning</h4><h4 id="eth-address-posioning"><a href="#eth-address-posioning" class="headerlink" title="eth address posioning"></a>eth address posioning</h4></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Dispa1r</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://dispa1r.github.io/2024/09/28/Blocksec-%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/">https://dispa1r.github.io/2024/09/28/Blocksec-%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://dispa1r.github.io" target="_blank">DravenLu</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/web3/">web3</a><a class="post-meta__tags" href="/tags/%E5%AE%89%E5%85%A8/">安全</a><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a></div><div class="post_share"><div class="social-share" data-image="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/09/28/9%E6%9C%88%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/"><img class="prev-cover" src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">9月安全笔记</div></div></a></div><div class="next-post pull-right"><a href="/2024/01/02/my-dark-2023/"><img class="next-cover" src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">my dark 2023</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/09/28/9%E6%9C%88%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/" title="9月安全笔记"><img class="cover" src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-28</div><div class="title">9月安全笔记</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://lh3.googleusercontent.com/WO1GMB2JeMcJnRdp8gthoxpF_pLHnceekNZdlqYBcwoArMMxnEVFxpytRjsXI-oJFR3BoepLBPGes1MO6VafBNwWxgRzIBMw1YcVjw=s0" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Dispa1r</div><div class="author-info__description">DravenLu的小屋</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/dispa1r"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/dispa1r" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/lrj001228@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#BlockSec-%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AE%89%E5%85%A8%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">BlockSec 区块链安全课程学习笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82-%E8%B4%A6%E5%8F%B7%E4%B8%8E%E4%BA%A4%E6%98%93"><span class="toc-number">1.1.</span> <span class="toc-text">第一节 账号与交易</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82-%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6"><span class="toc-number">1.2.</span> <span class="toc-text">第二节 智能合约</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E8%8A%82%E8%AF%BE-%E5%90%88%E7%BA%A6%E4%B8%8E%E5%AE%89%E5%85%A8%E6%A6%82%E5%BF%B5"><span class="toc-number">1.3.</span> <span class="toc-text">第三节课 合约与安全概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E8%8A%82%E8%AF%BE"><span class="toc-number">1.4.</span> <span class="toc-text">第四节课</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E8%8A%82-DEX%E4%B8%8EDEX%E5%AE%89%E5%85%A8"><span class="toc-number">1.5.</span> <span class="toc-text">第五节 DEX与DEX安全</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E7%AB%A0%E8%8A%82"><span class="toc-number">1.6.</span> <span class="toc-text">补充章节</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BGP-hijacking"><span class="toc-number">1.6.0.1.</span> <span class="toc-text">BGP hijacking</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#supply-chain-poisoning"><span class="toc-number">1.6.0.2.</span> <span class="toc-text">supply chain poisoning</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#eth-address-posioning"><span class="toc-number">1.6.0.3.</span> <span class="toc-text">eth address posioning</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/09/28/9%E6%9C%88%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/" title="9月安全笔记"><img src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="9月安全笔记"/></a><div class="content"><a class="title" href="/2024/09/28/9%E6%9C%88%E5%AE%89%E5%85%A8%E7%AC%94%E8%AE%B0/" title="9月安全笔记">9月安全笔记</a><time datetime="2024-09-27T16:54:07.000Z" title="发表于 2024-09-28 00:54:07">2024-09-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/28/Blocksec-%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" title="Blocksec 课程笔记"><img src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Blocksec 课程笔记"/></a><div class="content"><a class="title" href="/2024/09/28/Blocksec-%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" title="Blocksec 课程笔记">Blocksec 课程笔记</a><time datetime="2024-09-27T16:49:27.000Z" title="发表于 2024-09-28 00:49:27">2024-09-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/02/my-dark-2023/" title="my dark 2023"><img src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="my dark 2023"/></a><div class="content"><a class="title" href="/2024/01/02/my-dark-2023/" title="my dark 2023">my dark 2023</a><time datetime="2024-01-02T12:14:25.000Z" title="发表于 2024-01-02 20:14:25">2024-01-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/27/Falco%E5%85%A8%E8%A7%A3%E6%9E%90-%E4%B8%80/" title="Falco全解析(一)"><img src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Falco全解析(一)"/></a><div class="content"><a class="title" href="/2023/02/27/Falco%E5%85%A8%E8%A7%A3%E6%9E%90-%E4%B8%80/" title="Falco全解析(一)">Falco全解析(一)</a><time datetime="2023-02-27T08:29:20.000Z" title="发表于 2023-02-27 16:29:20">2023-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/27/%E5%AF%92%E5%81%87%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="寒假学习笔记"><img src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="寒假学习笔记"/></a><div class="content"><a class="title" href="/2023/02/27/%E5%AF%92%E5%81%87%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="寒假学习笔记">寒假学习笔记</a><time datetime="2023-02-27T03:21:01.000Z" title="发表于 2023-02-27 11:21:01">2023-02-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Dispa1r</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>