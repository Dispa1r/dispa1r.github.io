<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>NEAR subgraph tutorial | DravenLu</title><meta name="keywords" content="NEAR,Graph"><meta name="author" content="Dispa1r"><meta name="copyright" content="Dispa1r"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Building Production-Ready Subgraphs on NEARIf you’re building your DApps on NEAR and are interested to adopt The Graph technology to empower the frontend and analytics of your project, this tutorial i">
<meta property="og:type" content="article">
<meta property="og:title" content="NEAR subgraph tutorial">
<meta property="og:url" content="https://dispa1r.github.io/2022/06/06/NEAR-subgraph-tutorial/index.html">
<meta property="og:site_name" content="DravenLu">
<meta property="og:description" content="Building Production-Ready Subgraphs on NEARIf you’re building your DApps on NEAR and are interested to adopt The Graph technology to empower the frontend and analytics of your project, this tutorial i">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg">
<meta property="article:published_time" content="2022-06-06T06:52:36.000Z">
<meta property="article:modified_time" content="2022-06-06T06:53:32.565Z">
<meta property="article:author" content="Dispa1r">
<meta property="article:tag" content="NEAR">
<meta property="article:tag" content="Graph">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://dispa1r.github.io/2022/06/06/NEAR-subgraph-tutorial/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'NEAR subgraph tutorial',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-06-06 14:53:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://lh3.googleusercontent.com/WO1GMB2JeMcJnRdp8gthoxpF_pLHnceekNZdlqYBcwoArMMxnEVFxpytRjsXI-oJFR3BoepLBPGes1MO6VafBNwWxgRzIBMw1YcVjw=s0" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">DravenLu</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">NEAR subgraph tutorial</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-06-06T06:52:36.000Z" title="发表于 2022-06-06 14:52:36">2022-06-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-06-06T06:53:32.565Z" title="更新于 2022-06-06 14:53:32">2022-06-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="NEAR subgraph tutorial"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Building-Production-Ready-Subgraphs-on-NEAR"><a href="#Building-Production-Ready-Subgraphs-on-NEAR" class="headerlink" title="Building Production-Ready Subgraphs on NEAR"></a>Building Production-Ready Subgraphs on NEAR</h1><p>If you’re building your DApps on <a target="_blank" rel="noopener" href="https://near.org/">NEAR</a> and are interested to adopt <a target="_blank" rel="noopener" href="https://thegraph.com/">The Graph</a> technology to empower the frontend and analytics of your project, this tutorial is exactly for you.</p>
<p>Let’s get started!!! :rocket:</p>
<ul>
<li><a href="#background">Background</a></li>
<li><a href="#1-introduction-to-events-on-near">1. Introduction to Events on NEAR</a><ul>
<li><a href="#nep-297-event-standard">NEP-297 Event Standard</a></li>
<li><a href="#event-standards-for-ft-and-nft">Event Standards for FT and NFT</a></li>
</ul>
</li>
<li><a href="#2-implement-events-in-near-smart-contracts">2. Implement Events in NEAR Smart Contracts</a><ul>
<li><a href="#events-in-near-standard-contracts">Events in NEAR Standard Contracts</a></li>
<li><a href="#define-events-for-your-contract">Define Events for Your Contract</a></li>
<li><a href="#emit-events-in-your-contract">Emit Events in Your Contract</a></li>
<li><a href="#now-the-events-data-are-ready-for-indexing">Now the Events Data are Ready for Indexing</a></li>
</ul>
</li>
<li><a href="#3-create-subgraphs-with-the-graph">3. Create Subgraphs with The Graph</a><ul>
<li><a href="#set-your-objectives">Set your Objectives</a></li>
<li><a href="#create-manifest---subgraphyaml--">Create Manifest (<code>subgraph.yaml</code>)</a></li>
<li><a href="#design-schema---schemagraphql--">Design Schema (<code>schema.graphql</code>)</a></li>
<li><a href="#handle-events-with-assemblyscript-mappings">Handle Events with AssemblyScript Mappings</a></li>
<li><a href="#deploy-the-subgraph">Deploy the Subgraph</a></li>
</ul>
</li>
<li><a href="#4-querying-subgraphs">4. Querying Subgraphs</a><ul>
<li><a href="#query-with-playground">Query with Playground</a></li>
<li><a href="#query-with-graphql-client-in-code">Query with GraphQL Client in Code</a></li>
</ul>
</li>
<li><a href="#its-time-to-buidl-now">It’s time to BUIDL now!!!</a></li>
<li><a href="#about">About</a><ul>
<li><a href="#about-linear">About LiNEAR</a></li>
<li><a href="#about-the-graph">About The Graph</a></li>
</ul>
</li>
</ul>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>As the <a target="_blank" rel="noopener" href="https://thegraph.com/blog/graph-near">first non-EVM blockchain</a> supported by The Graph, NEAR blockchain allows developers to index data from events, actions, receipts and logs in NEAR smart contracts, and make best use of the data in their applications and analytics using The Graph. NEAR and The Graph integration utilizes StreamingFast’s Firehose interface which is a fast and scalable solution for layer one blockchain indexing.</p>
<p>There’re already some good tutorials about building subgraphs on NEAR, such as <a target="_blank" rel="noopener" href="https://github.com/dabit3/near-subgraph-workshop">Building an NFT API on NEAR with The Graph</a> by Nader, but no one has clearly described how to define and emit events in NEAR smart contracts, and how to process the events in The Graph properly in details.</p>
<p><a target="_blank" rel="noopener" href="https://linearprotocol.org/">LiNEAR</a>, a liquid staking protocol built on NEAR, is the first top tier projects on NEAR that has integrated The Graph in production and does benefit from the flexibility and power of subgraphs to improve statistics and analytics for its users and operations.</p>
<p>The integration makes it possible for the important metrics on LiNEAR, such as staking APY, liquidity pool APY, and users’ staking rewards, to be  queried from The Graph based on <a target="_blank" rel="noopener" href="https://nomicon.io/Standards/EventsFormat">NEAR Event Standard</a>, which replaces our previous less flexible and inefficient solution based on NEAR Indexer.</p>
<p>Here we’d like to share how LiNEAR has used events and subgraphs in the protocol, and hope that helps more developers to learn and build great projects with NEAR and The Graph.</p>
<p>In this tutorial, you’ll learn about:</p>
<ol>
<li>Introduction to Events on NEAR</li>
<li>Implement Events in Smart Contracts</li>
<li>Create Subgraphs with The Graph</li>
<li>Querying Subgraphs </li>
</ol>
<p><img src="https://i.imgur.com/gitBMeB.png" alt=""></p>
<h2 id="1-Introduction-to-Events-on-NEAR"><a href="#1-Introduction-to-Events-on-NEAR" class="headerlink" title="1. Introduction to Events on NEAR"></a>1. Introduction to Events on NEAR</h2><p>If you’re familiar with the practices of building with The Graph in Ethereum, it’s a common practice to handle the events from smart contracts using subgraphs. We’re following the same practice on NEAR.</p>
<h3 id="NEP-297-Event-Standard"><a href="#NEP-297-Event-Standard" class="headerlink" title="NEP-297 Event Standard"></a>NEP-297 Event Standard</h3><p>Here we’ll first introduce the <a target="_blank" rel="noopener" href="https://nomicon.io/Standards/EventsFormat">Event Standard NEP-297</a> of NEAR. </p>
<p>The event format NEP-297 is a standard interface for tracking contract activity, using the standard logs capability of NEAR. Events are log entries that start with the <code>EVENT_JSON:</code> prefix followed by a single valid JSON string, which has the following interface:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interface to capture data about an event</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// Arguments</span></span><br><span class="line"><span class="comment">// * `standard`: name of standard, e.g. nep171</span></span><br><span class="line"><span class="comment">// * `version`: e.g. 1.0.0</span></span><br><span class="line"><span class="comment">// * `event`: type of the event, e.g. nft_mint</span></span><br><span class="line"><span class="comment">// * `data`: associate event data. Strictly typed for each set &#123;</span></span><br><span class="line"><span class="comment">// standard, version, event&#125; inside corresponding NEP</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">EventLogData</span> &#123;</span><br><span class="line">    <span class="attr">standard</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">version</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">event</span>: <span class="built_in">string</span>,</span><br><span class="line">    data?: <span class="built_in">unknown</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In the event object, the <code>standard</code>, <code>version</code> and <code>event</code> fields are required, and the <code>data</code> field is optional. </p>
<ol>
<li>The <code>standard</code> field represents the standard the event follows, such as <code>nep141</code> for fungible token, and <code>nep171</code> for non-fungible token, or your application specific standard, such as <code>linear</code>.</li>
<li>The <code>version</code> field is the current version of your event definition. If you’ve modified the data schema of some events, it’s recommended to update the version so the subgraph could process events accordingly. </li>
<li>The <code>event</code> field is the event name, e.g. <code>ft_transfer</code>, <code>ft_mint</code>, <code>ft_burn</code> for fungible tokens, usually in snake case.</li>
<li>The <code>data</code> field includes the details of the event data. Take fungile token for example, if the event is <code>ft_transfer</code>, the data could be <code>[&#123;&quot;old_owner_id&quot;:&quot;alice&quot;,&quot;new_owner_id&quot;:&quot;bob&quot;,&quot;amount&quot;:&quot;1000000000000000000&quot;&#125;]</code>, which means Alice has transferred 1 token (with 18 decimals) to Bob.</li>
</ol>
<h3 id="Event-Standards-for-FT-and-NFT"><a href="#Event-Standards-for-FT-and-NFT" class="headerlink" title="Event Standards for FT and NFT"></a>Event Standards for FT and NFT</h3><p>The Fungible Token (NEP-141) and Non-Fungible Token (NEP-171) standards have defined their own standard interfaces for NEP-297 event format.</p>
<p>For example, a FT transfer event may look as below, when Alice transfers tokens to both Bob and Charlie in a batch.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">EVENT_JSON<span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;standard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nep141&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;event&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ft_transfer&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;old_owner_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alice.near&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;new_owner_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bob.near&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;amount&quot;</span><span class="punctuation">:</span> <span class="string">&quot;250&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;memo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tip&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;old_owner_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;alice.near&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;new_owner_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;charlie.near&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;amount&quot;</span><span class="punctuation">:</span> <span class="string">&quot;750&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>An NFT mint event example is as below, when two NFTs are minted for Dave. </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">EVENT_JSON<span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;standard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nep171&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;event&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nft_mint&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;owner_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dave.near&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;token_ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;superman&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;batman&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>For more details about the FT and NFT standard events, please check out the <a target="_blank" rel="noopener" href="https://nomicon.io/Standards/Tokens/FungibleToken/Event">FT Events</a> and <a target="_blank" rel="noopener" href="https://nomicon.io/Standards/Tokens/NonFungibleToken/Event">NFT Events</a> docs.</p>
<p>You’re also allowed to define your own events which we’ll talk about next. </p>
<h2 id="2-Implement-Events-in-NEAR-Smart-Contracts"><a href="#2-Implement-Events-in-NEAR-Smart-Contracts" class="headerlink" title="2. Implement Events in NEAR Smart Contracts"></a>2. Implement Events in NEAR Smart Contracts</h2><p>Now let’s implement events in your NEAR smart contract. In this tutorial, we’re building the smart contracts in Rust using <a target="_blank" rel="noopener" href="https://github.com/near/near-sdk-rs">NEAR Rust SDK</a>.</p>
<h3 id="Events-in-NEAR-Standard-Contracts"><a href="#Events-in-NEAR-Standard-Contracts" class="headerlink" title="Events in NEAR Standard Contracts"></a>Events in NEAR Standard Contracts</h3><p>If you have built your contracts based on <a target="_blank" rel="noopener" href="https://github.com/near/near-sdk-rs/tree/master/near-contract-standards"><code>near-contract-standards</code></a> crate, such as <a target="_blank" rel="noopener" href="https://examples.near.org/FT">fungible token</a> and <a target="_blank" rel="noopener" href="https://examples.near.org/NFT">non-fungible token</a>, you already have the built-in events implementation in your contract. So you can use that in subgraphs directly.</p>
<p>The implementation of fungible token events (<code>FtMint</code>, <code>FtBurn</code>, <code>FtTransfer</code>) can be found <a target="_blank" rel="noopener" href="https://github.com/near/near-sdk-rs/blob/master/near-contract-standards/src/fungible_token/events.rs">here</a>. Take <code>FtTransfer</code> for example, the event data schema and <code>emit</code> methods need to be implemented. </p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Data to log for an FT transfer event. To log this event,</span></span><br><span class="line"><span class="comment">/// call [`.emit()`](FtTransfer::emit).</span></span><br><span class="line"><span class="meta">#[must_use]</span></span><br><span class="line"><span class="meta">#[derive(Serialize, Debug, Clone)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">FtTransfer</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> old_owner_id: &amp;<span class="symbol">&#x27;a</span> AccountId,</span><br><span class="line">    <span class="keyword">pub</span> new_owner_id: &amp;<span class="symbol">&#x27;a</span> AccountId,</span><br><span class="line">    <span class="keyword">pub</span> amount: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">    <span class="meta">#[serde(skip_serializing_if = <span class="string">&quot;Option::is_none&quot;</span>)]</span></span><br><span class="line">    <span class="keyword">pub</span> memo: <span class="type">Option</span>&lt;&amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">FtTransfer</span>&lt;<span class="symbol">&#x27;_</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/// Logs the event to the host. This is required to ensure that the event is triggered</span></span><br><span class="line">    <span class="comment">/// and to consume the event.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">emit</span>(<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">Self</span>::<span class="title function_ invoke__">emit_many</span>(&amp;[<span class="keyword">self</span>])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Emits an FT transfer event, through [`env::log_str`](near_sdk::env::log_str),</span></span><br><span class="line">    <span class="comment">/// where each [`FtTransfer`] represents the data of each transfer.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">emit_many</span>(data: &amp;[FtTransfer&lt;<span class="symbol">&#x27;_</span>&gt;]) &#123;</span><br><span class="line">        <span class="title function_ invoke__">new_141_v1</span>(Nep141EventKind::<span class="title function_ invoke__">FtTransfer</span>(data)).<span class="title function_ invoke__">emit</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The defined <code>FtTransfer</code> event is emitted in <a target="_blank" rel="noopener" href="https://github.com/near/near-sdk-rs/blob/8a2b2e19b27a764abf43df05bd0e530c3ad91d6c/near-contract-standards/src/fungible_token/core_impl.rs#L91-L109"><code>internal_transfer</code></a>.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">internal_transfer</span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    sender_id: &amp;AccountId,</span><br><span class="line">    receiver_id: &amp;AccountId,</span><br><span class="line">    amount: Balance,</span><br><span class="line">    memo: <span class="type">Option</span>&lt;<span class="type">String</span>&gt;,</span><br><span class="line">) &#123;</span><br><span class="line">    require!(sender_id != receiver_id, <span class="string">&quot;Sender and receiver should be different&quot;</span>);</span><br><span class="line">    require!(amount &gt; <span class="number">0</span>, <span class="string">&quot;The amount should be a positive number&quot;</span>);</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">internal_withdraw</span>(sender_id, amount);</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">internal_deposit</span>(receiver_id, amount);</span><br><span class="line">    FtTransfer &#123;</span><br><span class="line">        old_owner_id: sender_id,</span><br><span class="line">        new_owner_id: receiver_id,</span><br><span class="line">        amount: &amp;<span class="title function_ invoke__">U128</span>(amount),</span><br><span class="line">        memo: memo.<span class="title function_ invoke__">as_deref</span>(),</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_ invoke__">emit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Define-Events-for-Your-Contract"><a href="#Define-Events-for-Your-Contract" class="headerlink" title="Define Events for Your Contract"></a>Define Events for Your Contract</h3><p>It’s quite common define you own events in your contract.</p>
<p>Here we’ll implement the events in LiNEAR as an example. LiNEAR is an liquid staking protocol that you could stake $NEAR and receive liquid $LiNEAR tokens while still earning staking rewards. We will create events for all the main activities. If you’re not familiar with LiNEAR’s features such as <code>Stake</code> and <code>Unstake</code>, we recommend that you spend 1 minute to <a target="_blank" rel="noopener" href="https://app.linearprotocol.org/">have a try</a>.</p>
<p>We’ll define the events for LiNEAR under <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/LiNEAR/blob/main/contracts/linear/src/events.rs"><code>events.rs</code></a> in the contract project.</p>
<p>(1) First, we can define the <code>standard</code> and <code>version</code> in EVENT_JSON as constants.  </p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> EVENT_STANDARD: &amp;<span class="type">str</span> = <span class="string">&quot;linear&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> EVENT_STANDARD_VERSION: &amp;<span class="type">str</span> = <span class="string">&quot;1.0.0&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>(2) We’ll define <code>enum Event</code> with all the event data schemas as enums.</p>
<p>For example, the user operations such as <code>deposit</code>, <code>withdraw</code>, <code>stake</code> and <code>unstake</code> will emit events with the necessary data. The name of the event (e.g. <code>Deposit</code>) will be turned into <code>event</code> field in EVENT_JSON, and the content of the enum (<code>account_id</code>, <code>amount</code> and <code>new_unstaked_balance</code>) will be transformed into <code>data</code> field in EVENT_JSON. </p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Serialize, Debug, Clone)]</span></span><br><span class="line"><span class="meta">#[serde(crate = <span class="string">&quot;near_sdk::serde&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[serde(tag = <span class="string">&quot;event&quot;</span>, content = <span class="string">&quot;data&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[serde(rename_all = <span class="string">&quot;snake_case&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Event</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Staking Pool Interface</span></span><br><span class="line">    Deposit &#123;</span><br><span class="line">        account_id: &amp;<span class="symbol">&#x27;a</span> AccountId,</span><br><span class="line">        amount: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">        new_unstaked_balance: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">    &#125;,</span><br><span class="line">    Withdraw &#123;</span><br><span class="line">        account_id: &amp;<span class="symbol">&#x27;a</span> AccountId,</span><br><span class="line">        amount: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">        new_unstaked_balance: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">    &#125;,</span><br><span class="line">    Stake &#123;</span><br><span class="line">        account_id: &amp;<span class="symbol">&#x27;a</span> AccountId,</span><br><span class="line">        staked_amount: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">        minted_stake_shares: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">        new_unstaked_balance: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">        new_stake_shares: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">    &#125;,</span><br><span class="line">    Unstake &#123;</span><br><span class="line">        account_id: &amp;<span class="symbol">&#x27;a</span> AccountId,</span><br><span class="line">        unstaked_amount: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">        burnt_stake_shares: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">        new_unstaked_balance: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">        new_stake_shares: &amp;<span class="symbol">&#x27;a</span> U128,</span><br><span class="line">        unstaked_available_epoch_height: <span class="type">u64</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>Events in LiNEAR have various types: user operation events, epoch actions events that can be triggered every epoch by anyone, and validator management events that are emitted when validators are added/removed in the pool. </p>
<p>(3) Add <code>emit()</code> method for your events, which will serialize your event data and log event JSON following NEP-297 standard.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Event</span>&lt;<span class="symbol">&#x27;_</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">emit</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">emit_event</span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Emit event that follows NEP-297 standard: https://nomicon.io/Standards/EventsFormat</span></span><br><span class="line"><span class="comment">// Arguments</span></span><br><span class="line"><span class="comment">// * `standard`: name of standard, e.g. nep171</span></span><br><span class="line"><span class="comment">// * `version`: e.g. 1.0.0</span></span><br><span class="line"><span class="comment">// * `event`: type of the event, e.g. nft_mint</span></span><br><span class="line"><span class="comment">// * `data`: associate event data. Strictly typed for each set &#123;standard, version, event&#125; inside corresponding NEP</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">emit_event</span>&lt;T: ?<span class="built_in">Sized</span> + Serialize&gt;(data: &amp;T) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = json!(data);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">event_json</span> = json!(&#123;</span><br><span class="line">        <span class="string">&quot;standard&quot;</span>: EVENT_STANDARD,</span><br><span class="line">        <span class="string">&quot;version&quot;</span>: EVENT_STANDARD_VERSION,</span><br><span class="line">        <span class="string">&quot;event&quot;</span>: result[<span class="string">&quot;event&quot;</span>],</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: [result[<span class="string">&quot;data&quot;</span>]]</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_ invoke__">to_string</span>();</span><br><span class="line">    log!(<span class="built_in">format!</span>(<span class="string">&quot;EVENT_JSON:&#123;&#125;&quot;</span>, event_json));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(4) If your contract contains a bunch of different events, we suggest you create unit tests for your events to make sure the generated EVENT_JSON logs look exactly as you think. Running <code>Event::Stake&#123;...&#125;.emit()</code> will output the EVENT JSON log.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">stake</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">account_id</span> = &amp;<span class="title function_ invoke__">alice</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">staked_amount</span> = &amp;<span class="title function_ invoke__">U128</span>(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">minted_stake_shares</span> = &amp;<span class="title function_ invoke__">U128</span>(<span class="number">99</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_unstaked_balance</span> = &amp;<span class="title function_ invoke__">U128</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_stake_shares</span> = &amp;<span class="title function_ invoke__">U128</span>(<span class="number">199</span>);</span><br><span class="line">    Event::Stake &#123;</span><br><span class="line">        account_id,</span><br><span class="line">        staked_amount,</span><br><span class="line">        minted_stake_shares,</span><br><span class="line">        new_unstaked_balance,</span><br><span class="line">        new_stake_shares,</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_ invoke__">emit</span>();</span><br><span class="line">    <span class="built_in">assert_eq!</span>(</span><br><span class="line">        test_utils::<span class="title function_ invoke__">get_logs</span>()[<span class="number">0</span>],</span><br><span class="line">        <span class="string">r#&quot;EVENT_JSON:&#123;&quot;standard&quot;:&quot;linear&quot;,&quot;version&quot;:&quot;1.0.0&quot;,&quot;event&quot;:&quot;stake&quot;,&quot;data&quot;:[&#123;&quot;account_id&quot;:&quot;alice&quot;,&quot;staked_amount&quot;:&quot;100&quot;,&quot;minted_stake_shares&quot;:&quot;99&quot;,&quot;new_unstaked_balance&quot;:&quot;10&quot;,&quot;new_stake_shares&quot;:&quot;199&quot;&#125;]&#125;&quot;#</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can find the complete example of defining events in <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/LiNEAR/blob/main/contracts/linear/src/events.rs"><code>events.rs</code></a>.</p>
<h3 id="Emit-Events-in-Your-Contract"><a href="#Emit-Events-in-Your-Contract" class="headerlink" title="Emit Events in Your Contract"></a>Emit Events in Your Contract</h3><p>Now we have defined events for the contract, let’s emit events in the right places. </p>
<p>We’ll illustrate how to emit events for <code>stake</code>, <code>unstake</code> and <code>epoch stake</code> actions in LiNEAR.</p>
<p>(1) <code>Stake</code> event is emitted in <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/LiNEAR/blob/2c78f26084bc8e999cea9643c0f7bf3c6aef06f5/contracts/linear/src/internal.rs#L102-L121"><code>internal_stake()</code></a> which is called by all stake functions. The account ID, balances, staked $NEAR amount, and minted $LiNEAR are recorded in the event. Also, one standard <code>FtMint</code> event is emitted since $LiNEAR is minted for the user after staking. </p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">internal_stake</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, amount: Balance) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.total_staked_near_amount += stake_amount;</span><br><span class="line">    <span class="keyword">self</span>.total_share_amount += num_shares;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Increase requested stake amount within the current epoch</span></span><br><span class="line">    <span class="keyword">self</span>.epoch_requested_stake_amount += stake_amount;</span><br><span class="line"></span><br><span class="line">    Event::Stake &#123;</span><br><span class="line">        account_id: &amp;account_id,</span><br><span class="line">        staked_amount: &amp;<span class="title function_ invoke__">U128</span>(charge_amount),</span><br><span class="line">        minted_stake_shares: &amp;<span class="title function_ invoke__">U128</span>(num_shares),</span><br><span class="line">        new_unstaked_balance: &amp;<span class="title function_ invoke__">U128</span>(account.unstaked),</span><br><span class="line">        new_stake_shares: &amp;<span class="title function_ invoke__">U128</span>(account.stake_shares),</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_ invoke__">emit</span>();</span><br><span class="line">    FtMint &#123;</span><br><span class="line">        owner_id: &amp;account_id,</span><br><span class="line">        amount: &amp;<span class="title function_ invoke__">U128</span>(num_shares),</span><br><span class="line">        memo: <span class="title function_ invoke__">Some</span>(<span class="string">&quot;stake&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_ invoke__">emit</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(2) <code>Unstake</code> event is emitted in <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/LiNEAR/blob/2c78f26084bc8e999cea9643c0f7bf3c6aef06f5/contracts/linear/src/internal.rs#L180-L200"><code>internal_unstake()</code></a>  which is called by all (delayed) unstake functions. The account ID, balances, burnt $LiNEAR, received $NEAR amount, and unstake available epoch height are recorded in the event. Also, one standard <code>FtBurn</code> event is emitted since $LiNEAR is burnt when the user is unstaking.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">internal_unstake</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, amount: <span class="type">u128</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.total_staked_near_amount -= unstake_amount;</span><br><span class="line">    <span class="keyword">self</span>.total_share_amount -= num_shares;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Increase requested unstake amount within the current epoch</span></span><br><span class="line">    <span class="keyword">self</span>.epoch_requested_unstake_amount += unstake_amount;</span><br><span class="line"></span><br><span class="line">    Event::Unstake &#123;</span><br><span class="line">        account_id: &amp;account_id,</span><br><span class="line">        unstaked_amount: &amp;<span class="title function_ invoke__">U128</span>(receive_amount),</span><br><span class="line">        burnt_stake_shares: &amp;<span class="title function_ invoke__">U128</span>(num_shares),</span><br><span class="line">        new_unstaked_balance: &amp;<span class="title function_ invoke__">U128</span>(account.unstaked),</span><br><span class="line">        new_stake_shares: &amp;<span class="title function_ invoke__">U128</span>(account.stake_shares),</span><br><span class="line">        unstaked_available_epoch_height: account.unstaked_available_epoch_height,</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_ invoke__">emit</span>();</span><br><span class="line">    FtBurn &#123;</span><br><span class="line">        owner_id: &amp;account_id,</span><br><span class="line">        amount: &amp;<span class="title function_ invoke__">U128</span>(num_shares),</span><br><span class="line">        memo: <span class="title function_ invoke__">Some</span>(<span class="string">&quot;unstake&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_ invoke__">emit</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(3) One thing needs to pay attention to in NEAR is that, because the cross-contract call is asynchronous in NEAR’s sharding design, to make sure the events are emitted in the expected status (e.g. entire transaction has been executed successfully), the events should be emitted in the appropriate functions or callbacks. </p>
<p>Let’s take a look at <code>EpochStakeAttempt</code>, <code>EpochStakeSuccess</code> and <code>EpochStakeFailed</code> as examples.</p>
<p>The <code>EpochStakeAttemp</code> event is emitted whenever the <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/LiNEAR/blob/2c78f26084bc8e999cea9643c0f7bf3c6aef06f5/contracts/linear/src/epoch_actions.rs#L54-L58"><code>epoch_stake</code> function</a> is called.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">epoch_stake</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// update internal state</span></span><br><span class="line">    <span class="keyword">self</span>.stake_amount_to_settle -= amount_to_stake;</span><br><span class="line"></span><br><span class="line">    Event::EpochStakeAttempt &#123;</span><br><span class="line">        validator_id: &amp;candidate.account_id,</span><br><span class="line">        amount: &amp;<span class="title function_ invoke__">U128</span>(amount_to_stake),</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_ invoke__">emit</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then we emit the epoch stake result events in the callback function – <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/LiNEAR/blob/2c78f26084bc8e999cea9643c0f7bf3c6aef06f5/contracts/linear/src/epoch_actions.rs#L360-L383"><code>validator_staked_callback()</code></a>. </p>
<p>The <code>EpochStakeSuccess</code> and <code>EpochStakeFailed</code> events are emitted only when the <code>epoch_stake</code> execution succeeded or failed, but <code>EpochStakeAttempt</code> is emitted as long as the <code>epoch_stake</code> function is executed.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">validator_staked_callback</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, validator_id: AccountId, amount: Balance) &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="title function_ invoke__">is_promise_success</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">validator</span> = <span class="keyword">self</span></span><br><span class="line">            .validator_pool</span><br><span class="line">            .<span class="title function_ invoke__">get_validator</span>(&amp;validator_id)</span><br><span class="line">            .<span class="title function_ invoke__">unwrap_or_else</span>(|| <span class="built_in">panic!</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>, ERR_VALIDATOR_NOT_EXIST, &amp;validator_id));</span><br><span class="line">        validator.<span class="title function_ invoke__">on_stake_success</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.validator_pool, amount);</span><br><span class="line"></span><br><span class="line">        Event::EpochStakeSuccess &#123;</span><br><span class="line">            validator_id: &amp;validator_id,</span><br><span class="line">            amount: &amp;<span class="title function_ invoke__">U128</span>(amount),</span><br><span class="line">        &#125;</span><br><span class="line">        .<span class="title function_ invoke__">emit</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// stake failed, revert</span></span><br><span class="line">        <span class="keyword">self</span>.stake_amount_to_settle += amount;</span><br><span class="line"></span><br><span class="line">        Event::EpochStakeFailed &#123;</span><br><span class="line">            validator_id: &amp;validator_id,</span><br><span class="line">            amount: &amp;<span class="title function_ invoke__">U128</span>(amount),</span><br><span class="line">        &#125;</span><br><span class="line">        .<span class="title function_ invoke__">emit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Now-the-Events-Data-are-Ready-for-Indexing"><a href="#Now-the-Events-Data-are-Ready-for-Indexing" class="headerlink" title="Now the Events Data are Ready for Indexing"></a>Now the Events Data are Ready for Indexing</h3><p>Using events in contract is quite straightforward. All you need to do is to define the events for the actions and emit them in the corresponding functions. </p>
<p>With the on-chain events data, you can now process the data through indexing technologies, such as <a target="_blank" rel="noopener" href="https://thegraph.com">The Graph</a>, <a target="_blank" rel="noopener" href="https://near-indexers.io/docs/projects/near-indexer-framework">NEAR Indexer</a> and <a target="_blank" rel="noopener" href="https://near-indexers.io/docs/projects/near-lake-framework">NEAR Lake</a>. </p>
<p>We recommend building your data solution with The Graph because it’s the most flexible, powerful and cost effective solution for DApps, while NEAR Indexer and NEAR Lake have their own best use cases that we’re not going to cover in this tutorial. </p>
<h2 id="3-Create-Subgraphs-with-The-Graph"><a href="#3-Create-Subgraphs-with-The-Graph" class="headerlink" title="3. Create Subgraphs with The Graph"></a>3. Create Subgraphs with The Graph</h2><p>With the event implemented in our contract, now we can develop and deploy subgraphs to capture and handle the events. </p>
<p>The general steps about how to develop a subgraph on NEAR can be found in <a target="_blank" rel="noopener" href="https://thegraph.com/docs/en/supported-networks/near/">the tutorial by The Graph team</a>. We recommend you go through it quickly if you haven’t.</p>
<p>In this tutorial, we’ll share the details about how to handle events, and how it works in production in the LiNEAR Protocol.</p>
<p>As mentioned in the <a target="_blank" rel="noopener" href="https://thegraph.com/docs/en/supported-networks/near/#building-a-near-subgraph">Building a NEAR Subgraph</a> tutorial, there are three aspects of subgraph definition:</p>
<ul>
<li><code>subgraph.yaml</code>: the subgraph manifest, defining the data sources, and how they should be processed.</li>
<li><code>schema.graphql</code>: a schema file that defines what data is stored for your subgraph, and how to query it via GraphQL.</li>
<li>AssemblyScript Mappings: <a target="_blank" rel="noopener" href="https://thegraph.com/docs/en/developer/assemblyscript-api/">AssemblyScript code</a> that translates from the event data to the entities defined in your schema. </li>
</ul>
<p>Next, we’ll talk about all the three aspects with linear-subgraph project as the example: <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/linear-subgraph">https://github.com/linear-protocol/linear-subgraph</a></p>
<p>But before that, let’s ensure we understand our objectives before we start.</p>
<h3 id="Set-your-Objectives"><a href="#Set-your-Objectives" class="headerlink" title="Set your Objectives"></a>Set your Objectives</h3><p>Before we start developing subgraphs, we should know what kind of info, stats, insights or stories we want to get out of the event data.</p>
<p>Some of the data could be queried via RPC from the smart contracts, but some statistics and analytics are easier to be queried from subgraph. We will need subgraphs for such cases. </p>
<p>For LiNEAR, we care about the staking APY, liquidity pool APY, and staking rewards of users, and would like to show the information in the <a target="_blank" rel="noopener" href="https://app.linearprotocol.org/">LiNEAR web UI</a>. We also care about analytics of users, validators, liquidity, etc., which could help us to improve the protocol.</p>
<p>In this tutorial, we’ll briefly talk about how to calculate the <strong>staking APY of LiNEAR Protocol</strong>, which is based on the growth of $LiNEAR price in the past 30 days. In order to reach this goal, we need to get the $LiNEAR price at any timestamp with The Graph. </p>
<h3 id="Create-Manifest-subgraph-yaml"><a href="#Create-Manifest-subgraph-yaml" class="headerlink" title="Create Manifest (subgraph.yaml)"></a>Create Manifest (<code>subgraph.yaml</code>)</h3><p>The subgraph manifest (<code>subgraph.yaml</code>) contains the below definitions: </p>
<ol>
<li><em>blockchain</em>: set data source <code>kind</code> to <code>near</code></li>
<li><em>network</em>: <code>near-mainnet</code> or <code>near-testnet</code></li>
<li><em>source account</em>: your contract account, e.g. <code>linear-protocol.near</code></li>
<li><em>start block</em>: usually the block when your contract was deployed</li>
<li><em>mapping file</em>: <code>./src/mapping/index.ts</code></li>
<li><em>entities</em>: the entities defined in the schema file</li>
<li><em>handler</em>: the handler function in your mapping file (<code>handleReceipt</code>). we use the <code>receiptHandlers</code> since the functions and events are processed at receipt level in NEAR</li>
</ol>
<p>See below for the manifest of the LiNEAR subgraph.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">specVersion:</span> <span class="number">0.0</span><span class="number">.4</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">LiNEAR</span> <span class="string">Protocol</span> <span class="string">subgraph</span></span><br><span class="line"><span class="attr">repository:</span> <span class="string">https://github.com/linear-protocol/linear-subgraph</span></span><br><span class="line"><span class="attr">schema:</span></span><br><span class="line">  <span class="attr">file:</span> <span class="string">./schema.graphql</span></span><br><span class="line"><span class="attr">dataSources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">near</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">receipts</span></span><br><span class="line">    <span class="attr">network:</span> &#123;&#123;<span class="string">network</span>&#125;&#125;</span><br><span class="line">    <span class="attr">source:</span></span><br><span class="line">      <span class="attr">account:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;contract&#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">startBlock:</span> &#123;&#123;<span class="string">startBlock</span>&#125;&#125;</span><br><span class="line">    <span class="attr">mapping:</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="number">0.0</span><span class="number">.5</span></span><br><span class="line">      <span class="attr">language:</span> <span class="string">wasm/assemblyscript</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">./src/mapping/index.ts</span></span><br><span class="line">      <span class="attr">entities:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">User</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Price</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">TotalSwapFee</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Status</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">FtTransfer</span></span><br><span class="line">      <span class="attr">receiptHandlers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">handler:</span> <span class="string">handleReceipt</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The placeholders <code>&#123;&#123;network&#125;&#125;</code>, <code>&#123;&#123;contract&#125;&#125;</code>, <code>&#123;&#123;startBlock&#125;&#125;</code> are populated with different configurations for mainnet and testnet, which are defined in <code>./config/mainnet.json</code> and <code>./config/testnet.json</code>.</p>
<p><em>./config/mainnet.json</em></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;near-mainnet&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;contract&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linear-protocol.near&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;startBlock&quot;</span><span class="punctuation">:</span> <span class="number">61147683</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="Design-Schema-schema-graphql"><a href="#Design-Schema-schema-graphql" class="headerlink" title="Design Schema (schema.graphql)"></a>Design Schema (<code>schema.graphql</code>)</h3><p>Schema describes the structure of the resulting subgraph database and the relationships between entities. Please notice that the entities are not necessary to be the same as the events we defined in our smart contracts.</p>
<p>The recommended way is to define the schema based on your data queries and analytics objectives, and the data models in your application. In the case of LiNEAR, we have defined:</p>
<ul>
<li><strong>User</strong>: tracks the latest states of each user such as first staking time, transferred amount in total, accumulated minted LiNEAR amount in total, etc. which are not available in contract’s states. You probably also need the <em>User</em> entity in your application as long as you have users.</li>
<li><strong>Price</strong>: the $LiNEAR price at the timestamp when the total staked NEAR or total supply of $LiNEAR changes. At any given timestamp, <code>$LiNEAR price = total staked NEAR plus its staking rewards / total supply of LiNEAR</code></li>
<li><strong>TotalSwapFee</strong>: records the total paid swap fees to the liquidity pool at any timestamp when there’re new fees paid</li>
<li><strong>Status</strong>: records global status such as latest version IDs of prices and total swap fees.</li>
</ul>
<p>The <a target="_blank" rel="noopener" href="https://thegraph.com/docs/en/developer/create-subgraph-hosted/#built-in-scalar-types">built-in scalar types</a> in The Graph’s GraphQL API are helpful for defining the schema . </p>
<p><img src="https://i.imgur.com/kc68mnt.png" alt=""></p>
<p>Below lists the schema for <strong>User</strong> and <strong>Price</strong> in LiNEAR.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">type User @entity&#123;</span><br><span class="line">   id: ID!</span><br><span class="line">   mintedLinear: BigInt!</span><br><span class="line">   unstakedLinear: BigInt!</span><br><span class="line">   stakedNear: BigInt!</span><br><span class="line">   unstakeReceivedNear: BigInt!</span><br><span class="line">   firstStakingTime: BigInt!</span><br><span class="line">   transferedInValue: BigDecimal!</span><br><span class="line">   transferedOutValue: BigDecimal!</span><br><span class="line">   transferedInShares: BigInt!</span><br><span class="line">   transferedOutShares: BigInt!</span><br><span class="line">   feesPaid: BigInt!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Price @entity&#123;</span><br><span class="line">   id: ID!</span><br><span class="line">   timestamp: BigInt!</span><br><span class="line">   method: String!</span><br><span class="line">   event: String!</span><br><span class="line">   receiptHash: String!</span><br><span class="line">   deltaLinearAmount: BigDecimal!</span><br><span class="line">   deltaNearAmount: BigDecimal!</span><br><span class="line">   totalLinearAmount: BigDecimal!</span><br><span class="line">   totalNearAmount: BigDecimal!</span><br><span class="line">   price: BigDecimal!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now we can run <code>npm run codegen</code> in the LiNEAR subgraph project to generate the schema definitions to <code>./generated/schema.ts</code> that can be used in the mapping files. </p>
<h3 id="Handle-Events-with-AssemblyScript-Mappings"><a href="#Handle-Events-with-AssemblyScript-Mappings" class="headerlink" title="Handle Events with AssemblyScript Mappings"></a>Handle Events with AssemblyScript Mappings</h3><p>In general, The Graph works by traversing all or some of the blocks of the blockchain, and processing the data (e.g. events) in the block with the handlers designed by developers. </p>
<p>There are currently two types of handlers supported for NEAR subgraphs:</p>
<ul>
<li>block handlers: run on every new block</li>
<li>receipt handlers: run every time some actions are executed at a specified account</li>
</ul>
<p>As mentioned when defining <code>subgraph.yaml</code>, we use the receipt handler in LiNEAR. As long as your application is relying on one or several smart contracts, you should probably also use the receipt handler. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receiptHandlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">handler:</span> <span class="string">handleReceipt</span></span><br></pre></td></tr></table></figure>
<p>In the AssemblyScript mapping file <code>./src/mapping/index.ts</code>, firstly we process the logs in the current receipt, and extract the event data from the logs, and pass them to <code>handleEvent</code>.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleAction</span>(<span class="params"></span></span><br><span class="line"><span class="params">  action: near.ActionValue,</span></span><br><span class="line"><span class="params">  receipt: near.ReceiptWithOutcome</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (action.<span class="property">kind</span> != near.<span class="property">ActionKind</span>.<span class="property">FUNCTION_CALL</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> outcome = receipt.<span class="property">outcome</span>;</span><br><span class="line">  <span class="keyword">const</span> methodName = action.<span class="title function_">toFunctionCall</span>().<span class="property">methodName</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> logIndex = <span class="number">0</span>; logIndex &lt; outcome.<span class="property">logs</span>.<span class="property">length</span>; logIndex++) &#123;</span><br><span class="line">    <span class="keyword">let</span> outcomeLog = outcome.<span class="property">logs</span>[logIndex].<span class="title function_">toString</span>();</span><br><span class="line">    <span class="keyword">if</span> (outcomeLog.<span class="title function_">startsWith</span>(<span class="string">&#x27;EVENT_JSON:&#x27;</span>)) &#123;</span><br><span class="line">      outcomeLog = outcomeLog.<span class="title function_">replace</span>(<span class="string">&#x27;EVENT_JSON:&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> jsonData = json.<span class="title function_">try_fromString</span>(outcomeLog);</span><br><span class="line">      <span class="keyword">const</span> jsonObject = jsonData.<span class="property">value</span>.<span class="title function_">toObject</span>();</span><br><span class="line">      <span class="keyword">const</span> event = jsonObject.<span class="title function_">get</span>(<span class="string">&#x27;event&#x27;</span>)!;</span><br><span class="line">      <span class="keyword">const</span> dataArr = jsonObject.<span class="title function_">get</span>(<span class="string">&#x27;data&#x27;</span>)!.<span class="title function_">toArray</span>();</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">dataObj</span>: <span class="title class_">TypedMap</span>&lt;<span class="built_in">string</span>, <span class="title class_">JSON</span>Value&gt; = dataArr[<span class="number">0</span>].<span class="title function_">toObject</span>();</span><br><span class="line"></span><br><span class="line">      <span class="title function_">handleEvent</span>(methodName, event.<span class="title function_">toString</span>(), dataObj, receipt);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">handleReceipt</span>(<span class="params">receipt: near.ReceiptWithOutcome</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> actions = receipt.<span class="property">receipt</span>.<span class="property">actions</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; actions.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">handleAction</span>(actions[i], receipt);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As one of our goals is to calculate the $LiNEAR price, we need to track all the actions that might impact the total staked NEAR plus its rewards, and the total supply of LiNEAR. </p>
<p>To avoid delving into too many details, here we illustrate how to process the <code>EpochUpdateRewards</code> event when the staking rewards are fetched from validators every epoch, which increases the $LiNEAR price.</p>
<p>By looking at <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/LiNEAR/blob/2c78f26084bc8e999cea9643c0f7bf3c6aef06f5/contracts/linear/src/epoch_actions.rs#L456-L462">the contract code</a>, we know <code>epoch_update_rewards()</code> function and its callback <code>validator_get_balance_callback()</code> will trigger the <code>EpochUpdateRewards</code>, we filter the condition by method name and event name, and then call the corresponding event handler <code>handleEpochUpdateRewards</code>. (Note: <code>method == &#39;epoch_update_rewards&#39;</code> is actually not needed and can be removed, because the event is only emitted in the callback <code>validator_get_balance_callback</code>.)</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleEvent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  method: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  event: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  data: TypedMap&lt;<span class="built_in">string</span>, JSONValue&gt;,</span></span><br><span class="line"><span class="params">  receipt: near.ReceiptWithOutcome</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    method == <span class="string">&#x27;epoch_update_rewards&#x27;</span> ||</span><br><span class="line">    method == <span class="string">&#x27;validator_get_balance_callback&#x27;</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (event == <span class="string">&#x27;epoch_update_rewards&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">handleEpochUpdateRewards</span>(method, event, data, receipt);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event == <span class="string">&#x27;ft_mint&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">handleFtMint</span>(method, event, data, receipt);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In <code>./src/mapping/epoch-action.ts</code>, we have implemented the event handler for <code>EpochUpdateRewards</code>, which will update the $LiNEAR price based on the received staking rewards. </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">handleEpochUpdateRewards</span>(<span class="params"></span></span><br><span class="line"><span class="params">  method: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  event: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  data: TypedMap&lt;<span class="built_in">string</span>, JSONValue&gt;,</span></span><br><span class="line"><span class="params">  receipt: near.ReceiptWithOutcome</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> rewards = <span class="title class_">BigDecimal</span>.<span class="title function_">fromString</span>(data.<span class="title function_">get</span>(<span class="string">&#x27;rewards&#x27;</span>)!.<span class="title function_">toString</span>());</span><br><span class="line">  <span class="title function_">updatePrice</span>(event, method, receipt, rewards, <span class="title class_">BigDecimal</span>.<span class="title function_">zero</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It’s also necessary to handle <code>FtMint</code> when updating staking rewards because around <code>1%</code> commission fee is charged and sent to the treasury in the form of $LiNEAR. </p>
<p>In <code>./src/mappping/fungible-token.ts</code>,</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">handleFtMint</span>(<span class="params"></span></span><br><span class="line"><span class="params">  method: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  event: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  data: TypedMap&lt;<span class="built_in">string</span>, JSONValue&gt;,</span></span><br><span class="line"><span class="params">  receipt: near.ReceiptWithOutcome</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> amount = <span class="title class_">BigDecimal</span>.<span class="title function_">fromString</span>(data.<span class="title function_">get</span>(<span class="string">&#x27;amount&#x27;</span>)!.<span class="title function_">toString</span>());</span><br><span class="line">  <span class="title function_">updatePrice</span>(event, method, receipt, <span class="title class_">BigDecimal</span>.<span class="title function_">zero</span>(), amount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can also take a look how <code>updatePrice()</code> works in <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/linear-subgraph/blob/b13779eee7c233932b1ed58090c553b75464bdb6/src/helper/price.ts#L5-L36"><code>./src/helper/price.ts</code></a>:</p>
<ol>
<li>The last <code>Price</code> object will be read from the <code>Price</code> entities by using the last price version ID saved in <code>Status</code> entity, which is a global state that tracks the latest versions of price, total swap fees, etc.;</li>
<li>A new <code>Price</code> entity will be created with delta $NEAR / $LiNEAR amount, the updated total $NEAR / $LiNEAR amount, current $LiNEAR price, and other relevant info such as event name, method name, timestamp, etc., and saved into the database;</li>
<li>Increment the latest Price version ID, and update the latest price value in the global <code>Status</code> record, which will be used in next <code>updatePrice()</code> call.</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">updatePrice</span>(<span class="params"></span></span><br><span class="line"><span class="params">  event: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  method: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  receipt: near.ReceiptWithOutcome,</span></span><br><span class="line"><span class="params">  deltaNear: BigDecimal,</span></span><br><span class="line"><span class="params">  deltaLinear: BigDecimal</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> timestamp = receipt.<span class="property">block</span>.<span class="property">header</span>.<span class="property">timestampNanosec</span>;</span><br><span class="line">  <span class="keyword">const</span> receiptHash = receipt.<span class="property">receipt</span>.<span class="property">id</span>.<span class="title function_">toBase58</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> status = <span class="title function_">getOrInitStatus</span>();</span><br><span class="line">  <span class="keyword">let</span> lastPrice = <span class="title function_">getOrInitPrice</span>(status.<span class="property">priceVersion</span>.<span class="title function_">toString</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create new price</span></span><br><span class="line">  <span class="keyword">const</span> nextVersion = status.<span class="property">priceVersion</span>.<span class="title function_">plus</span>(<span class="title class_">BigInt</span>.<span class="title function_">fromU32</span>(<span class="number">1</span>));</span><br><span class="line">  <span class="keyword">let</span> nextPrice = <span class="keyword">new</span> <span class="title class_">Price</span>(nextVersion.<span class="title function_">toString</span>());</span><br><span class="line">  nextPrice.<span class="property">deltaNearAmount</span> = deltaNear;</span><br><span class="line">  nextPrice.<span class="property">deltaLinearAmount</span> = deltaLinear;</span><br><span class="line">  nextPrice.<span class="property">totalNearAmount</span> = lastPrice.<span class="property">totalNearAmount</span>.<span class="title function_">plus</span>(deltaNear);</span><br><span class="line">  nextPrice.<span class="property">totalLinearAmount</span> = lastPrice.<span class="property">totalLinearAmount</span>.<span class="title function_">plus</span>(deltaLinear);</span><br><span class="line">  nextPrice.<span class="property">price</span> = nextPrice.<span class="property">totalNearAmount</span>.<span class="title function_">div</span>(nextPrice.<span class="property">totalLinearAmount</span>);</span><br><span class="line">  nextPrice.<span class="property">timestamp</span> = <span class="title class_">BigInt</span>.<span class="title function_">fromU64</span>(timestamp);</span><br><span class="line">  nextPrice.<span class="property">event</span> = event;</span><br><span class="line">  nextPrice.<span class="property">receiptHash</span> = receiptHash;</span><br><span class="line">  nextPrice.<span class="property">method</span> = method;</span><br><span class="line">  nextPrice.<span class="title function_">save</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// update status</span></span><br><span class="line">  status.<span class="property">priceVersion</span> = nextVersion;</span><br><span class="line">  status.<span class="property">price</span> = nextPrice.<span class="property">price</span>;</span><br><span class="line">  status.<span class="title function_">save</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now that we have all the versioned prices in history, it would be easy to calculate the staking APY which is reflected by the growth of $LiNEAR price. </p>
<h3 id="Deploy-the-Subgraph"><a href="#Deploy-the-Subgraph" class="headerlink" title="Deploy the Subgraph"></a>Deploy the Subgraph</h3><p>Now we have built the subgraph. It’s the time to deploy it to <a target="_blank" rel="noopener" href="https://thegraph.com/docs/en/hosted-service/deploy-subgraph-hosted/">The Graph’s Hosted Service</a> for indexing. </p>
<p>First, you need to create your subgraph in the <a target="_blank" rel="noopener" href="https://thegraph.com/hosted-service/dashboard">Hosted Service dashboard</a> by clicking “Add Subgraph” button, or just visit <a target="_blank" rel="noopener" href="https://thegraph.com/hosted-service/subgraph/create?account=All%20Subgraphs">this link</a>. Fill in the necessary description for the subgraph will be good enough.</p>
<p><img src="https://i.imgur.com/a0L9sNo.png" alt=""></p>
<p>Next, you can follow the steps in <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/linear-subgraph/blob/main/README.md#development">README</a> to deploy LiNEAR subgraph to either testnet or mainnet. Don’t forget to replace the <code>SLUG</code> and <code>ACCESS_TOKEN</code> in <code>.env</code> with yours.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># copy env and adjust its content</span></span><br><span class="line"><span class="comment"># you can get an access token from https://thegraph.com/explorer/dashboard</span></span><br><span class="line"><span class="built_in">cp</span> .env.example .<span class="built_in">env</span></span><br><span class="line"><span class="comment"># install project dependencies</span></span><br><span class="line">npm i</span><br><span class="line"><span class="comment"># prepare subgraph.yaml</span></span><br><span class="line">npm run prepare:mainnet</span><br><span class="line"><span class="comment"># run codegen</span></span><br><span class="line">npm run codegen</span><br><span class="line"><span class="comment"># now you&#x27;re able to deploy to thegraph via</span></span><br><span class="line">npm run deploy</span><br></pre></td></tr></table></figure>
<p>After waiting a while (minutes to even hours, depending on how complex your mapping handler is and how long your project exists), your subgraph should be synchronized. You can always check the latest status of your subgraph in the hosted service site (e.g. <a target="_blank" rel="noopener" href="https://thegraph.com/hosted-service/subgraph/linear-protocol/linear-testnet">https://thegraph.com/hosted-service/subgraph/linear-protocol/linear-testnet</a>)</p>
<p><img src="https://i.imgur.com/jYfcRhp.png" alt=""></p>
<h2 id="4-Querying-Subgraphs"><a href="#4-Querying-Subgraphs" class="headerlink" title="4. Querying Subgraphs"></a>4. Querying Subgraphs</h2><p>Thanks for staying so long with us. :muscle: Now it’s time to query our subgraph!!!</p>
<p>You’ll need to <a target="_blank" rel="noopener" href="https://graphql.org/learn/">learn a bit about <strong>GraphQL</strong></a> and <a target="_blank" rel="noopener" href="https://thegraph.com/docs/en/developer/graphql-api/">The Graph’s GraphQL API</a> if you didn’t use it before.</p>
<p>We have at least two ways to query data:</p>
<ol>
<li>using the playground of your subgraph;</li>
<li>using the GraphQL client in your code</li>
</ol>
<h3 id="Query-with-Playground"><a href="#Query-with-Playground" class="headerlink" title="Query with Playground"></a>Query with Playground</h3><p>After deploying your subgraph and the sync is done, you’ll be able to query with the playground. (e.g. LiNEAR’s testnet subgraph: <a target="_blank" rel="noopener" href="https://thegraph.com/hosted-service/subgraph/linear-protocol/linear-testnet">https://thegraph.com/hosted-service/subgraph/linear-protocol/linear-testnet</a>)</p>
<p><img src="https://i.imgur.com/DwT6lIf.png" alt=""></p>
<p>In the playground, you can edit, save and execute your GraphQL queries. </p>
<p>In the above screenshot, we have queried 100 users with the fields we’re interested in. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  users(first: 100) &#123;</span><br><span class="line">    id</span><br><span class="line">    mintedLinear</span><br><span class="line">    unstakedLinear</span><br><span class="line">    stakedNear</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Query-with-GraphQL-Client-in-Code"><a href="#Query-with-GraphQL-Client-in-Code" class="headerlink" title="Query with GraphQL Client in Code"></a>Query with GraphQL Client in Code</h3><p>Usually we’ll query subgraph in our application frontend and analytics/statistics tools. We can use any GraphQL client such as Apollo Client or URQL as suggested by <a target="_blank" rel="noopener" href="https://thegraph.com/docs/en/developer/querying-from-your-app/">The Graph’s docs</a>. </p>
<p>Here we use <code>urql</code> library as an example.</p>
<p>(1) Get the GraphQL endpoint for our subgraph: <code>https://api.thegraph.com/subgraphs/name/&lt;username&gt;/&lt;subgraph_name&gt;</code></p>
<p>(2) Create the URQL client. </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createClient &#125; = <span class="built_in">require</span>(<span class="string">&#x27;urql&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = <span class="title function_">createClient</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: config.<span class="property">subgraph</span>.<span class="property">apiUrl</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>(3) Query the subgraph with the URQL client. </p>
<p>Here we’d like to query the $LiNEAR price 30 days ago, so we can calculate the staking APY with it. You can find more query examples in the <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/linear-subgraph/blob/b13779eee7c233932b1ed58090c553b75464bdb6/test/price.js#L4-L23"><code>./test</code> folder</a>. </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">queryPriceBefore</span>(<span class="params">timestamp</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> query = <span class="string">`</span></span><br><span class="line"><span class="string">      query &#123;</span></span><br><span class="line"><span class="string">        prices (first: 1, orderBy: timestamp, orderDirection: desc,</span></span><br><span class="line"><span class="string">          where: &#123;timestamp_lte: &quot;<span class="subst">$&#123;timestamp.toString()&#125;</span>&quot;&#125; )</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          id</span></span><br><span class="line"><span class="string">          timestamp</span></span><br><span class="line"><span class="string">          price</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;`</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; data &#125; = <span class="keyword">await</span> client.<span class="title function_">query</span>(query).<span class="title function_">toPromise</span>();</span><br><span class="line">  <span class="keyword">if</span> (data == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Failed to query price&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> data.<span class="property">prices</span>[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can also get the latest $LiNEAR price from contract, and we already have queried the $LiNEAR price 30 days before now, we’ll be able to calculate the staking rewards with the formula <code>(price (now) - price (30 days ago)) / 30 * 365</code>. We finally make it!!!</p>
<p><em>P.S.</em> At LiNEAR Protocol, we have built a SDK based on the subgraph queries, which is used in our frontend and analytics. Please feel free to <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/linear-sdk">check out</a> if you’re intersted to build your own SDKs.</p>
<h2 id="It’s-time-to-BUIDL-now"><a href="#It’s-time-to-BUIDL-now" class="headerlink" title="It’s time to BUIDL now!!!"></a>It’s time to BUIDL now!!!</h2><p>Congratulations, my friend! :birthday: </p>
<p>You have learnt about the details of building subgraphs on NEAR with events, from implementing and emitting the events in your smart contract, to building, deploying and querying the subgraphs that process your events.</p>
<p>Besides this tutorial, there are other excellent guides that will help you learn more about using The Graph on NEAR.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://thegraph.com/docs/en/supported-networks/near/">Building Subgraphs on NEAR</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dabit3/near-subgraph-workshop">Building an NFT API on NEAR with The Graph</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/graphprotocol/example-subgraph/tree/near-receipts-example">Example NEAR Receipts Subgraph: Good Morning NEAR</a></li>
<li><a target="_blank" rel="noopener" href="https://thegraph.com/docs/en/developer/quick-start/">Quick Start Guide of The Graph</a></li>
</ul>
<p>Now it’s your time to start building and hacking. If you have any questions, please feel free to <a target="_blank" rel="noopener" href="https://github.com/linear-protocol/linear-subgraph/discussions">discuss with us in the <code>linear-protocol/linear-subgraph</code> repo</a>. Good luck!</p>
<h2 id="About"><a href="#About" class="headerlink" title="About"></a>About</h2><h3 id="About-LiNEAR"><a href="#About-LiNEAR" class="headerlink" title="About LiNEAR"></a>About LiNEAR</h3><p>LiNEAR Protocol is a liquid staking solution built on the NEAR Protocol. LiNEAR unlocks liquidity of the staked NEAR by creating a staking derivative to be engaged with various DeFi protocols on NEAR and Aurora, while also enjoying over 10% APY staking rewards of the underlying base tokens. LiNEAR is the cornerstone of the NEAR-Aurora DeFi ecosystem.</p>
<h3 id="About-The-Graph"><a href="#About-The-Graph" class="headerlink" title="About The Graph"></a>About The Graph</h3><p>The Graph is the indexing and query layer of web3. Developers build and publish open APIs, called subgraphs, that applications can query using GraphQL. The Graph currently supports indexing data from 31 different networks including Ethereum, NEAR, Arbitrium, Optimism, Polygon, Avalanche, Celo, Fantom, Moonbeam, IPFS, and PoA with more networks coming soon. Developers build and publish open APIs, called subgraphs, that applications can query using GraphQL.</p>
<p><img src="https://i.imgur.com/yZSgnsT.png" alt=""></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Dispa1r</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://dispa1r.github.io/2022/06/06/NEAR-subgraph-tutorial/">https://dispa1r.github.io/2022/06/06/NEAR-subgraph-tutorial/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://dispa1r.github.io" target="_blank">DravenLu</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/NEAR/">NEAR</a><a class="post-meta__tags" href="/tags/Graph/">Graph</a></div><div class="post_share"><div class="social-share" data-image="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/06/06/%E8%B7%A8%E9%93%BE%E8%AE%BA%E6%96%87-IOTJ2021/"><img class="prev-cover" src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">跨链论文-IOTJ2021</div></div></a></div><div class="next-post pull-right"><a href="/2022/05/18/The-Graph%E5%BC%80%E5%8F%91%E5%BF%83%E5%BE%97-NEAR/"><img class="next-cover" src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">The Graph开发心得(NEAR)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/05/18/The-Graph%E5%BC%80%E5%8F%91%E5%BF%83%E5%BE%97-NEAR/" title="The Graph开发心得(NEAR)"><img class="cover" src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-18</div><div class="title">The Graph开发心得(NEAR)</div></div></a></div><div><a href="/2022/05/04/Build-NEAR-app-with-Airtable-Glide/" title="Build NEAR app with Airtable/Glide"><img class="cover" src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-04</div><div class="title">Build NEAR app with Airtable/Glide</div></div></a></div><div><a href="/2022/05/04/Build-a-telegram-red-packet-bot/" title="Build a telegram red packet bot"><img class="cover" src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-04</div><div class="title">Build a telegram red packet bot</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://lh3.googleusercontent.com/WO1GMB2JeMcJnRdp8gthoxpF_pLHnceekNZdlqYBcwoArMMxnEVFxpytRjsXI-oJFR3BoepLBPGes1MO6VafBNwWxgRzIBMw1YcVjw=s0" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Dispa1r</div><div class="author-info__description">DravenLu的小屋</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/dispa1r"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/dispa1r" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/lrj001228@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Building-Production-Ready-Subgraphs-on-NEAR"><span class="toc-number">1.</span> <span class="toc-text">Building Production-Ready Subgraphs on NEAR</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Background"><span class="toc-number">1.1.</span> <span class="toc-text">Background</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Introduction-to-Events-on-NEAR"><span class="toc-number">1.2.</span> <span class="toc-text">1. Introduction to Events on NEAR</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NEP-297-Event-Standard"><span class="toc-number">1.2.1.</span> <span class="toc-text">NEP-297 Event Standard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Event-Standards-for-FT-and-NFT"><span class="toc-number">1.2.2.</span> <span class="toc-text">Event Standards for FT and NFT</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Implement-Events-in-NEAR-Smart-Contracts"><span class="toc-number">1.3.</span> <span class="toc-text">2. Implement Events in NEAR Smart Contracts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Events-in-NEAR-Standard-Contracts"><span class="toc-number">1.3.1.</span> <span class="toc-text">Events in NEAR Standard Contracts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Define-Events-for-Your-Contract"><span class="toc-number">1.3.2.</span> <span class="toc-text">Define Events for Your Contract</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Emit-Events-in-Your-Contract"><span class="toc-number">1.3.3.</span> <span class="toc-text">Emit Events in Your Contract</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Now-the-Events-Data-are-Ready-for-Indexing"><span class="toc-number">1.3.4.</span> <span class="toc-text">Now the Events Data are Ready for Indexing</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Create-Subgraphs-with-The-Graph"><span class="toc-number">1.4.</span> <span class="toc-text">3. Create Subgraphs with The Graph</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Set-your-Objectives"><span class="toc-number">1.4.1.</span> <span class="toc-text">Set your Objectives</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Create-Manifest-subgraph-yaml"><span class="toc-number">1.4.2.</span> <span class="toc-text">Create Manifest (subgraph.yaml)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Design-Schema-schema-graphql"><span class="toc-number">1.4.3.</span> <span class="toc-text">Design Schema (schema.graphql)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Handle-Events-with-AssemblyScript-Mappings"><span class="toc-number">1.4.4.</span> <span class="toc-text">Handle Events with AssemblyScript Mappings</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deploy-the-Subgraph"><span class="toc-number">1.4.5.</span> <span class="toc-text">Deploy the Subgraph</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Querying-Subgraphs"><span class="toc-number">1.5.</span> <span class="toc-text">4. Querying Subgraphs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Query-with-Playground"><span class="toc-number">1.5.1.</span> <span class="toc-text">Query with Playground</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Query-with-GraphQL-Client-in-Code"><span class="toc-number">1.5.2.</span> <span class="toc-text">Query with GraphQL Client in Code</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#It%E2%80%99s-time-to-BUIDL-now"><span class="toc-number">1.6.</span> <span class="toc-text">It’s time to BUIDL now!!!</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#About"><span class="toc-number">1.7.</span> <span class="toc-text">About</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#About-LiNEAR"><span class="toc-number">1.7.1.</span> <span class="toc-text">About LiNEAR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#About-The-Graph"><span class="toc-number">1.7.2.</span> <span class="toc-text">About The Graph</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/02/27/Falco%E5%85%A8%E8%A7%A3%E6%9E%90-%E4%B8%80/" title="Falco全解析(一)"><img src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Falco全解析(一)"/></a><div class="content"><a class="title" href="/2023/02/27/Falco%E5%85%A8%E8%A7%A3%E6%9E%90-%E4%B8%80/" title="Falco全解析(一)">Falco全解析(一)</a><time datetime="2023-02-27T08:29:20.000Z" title="发表于 2023-02-27 16:29:20">2023-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/02/27/%E5%AF%92%E5%81%87%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="寒假学习笔记"><img src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="寒假学习笔记"/></a><div class="content"><a class="title" href="/2023/02/27/%E5%AF%92%E5%81%87%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="寒假学习笔记">寒假学习笔记</a><time datetime="2023-02-27T03:21:01.000Z" title="发表于 2023-02-27 11:21:01">2023-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/19/Unpack-Objection%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Unpack &amp;&amp; Objection学习笔记"><img src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Unpack &amp;&amp; Objection学习笔记"/></a><div class="content"><a class="title" href="/2022/07/19/Unpack-Objection%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="Unpack &amp;&amp; Objection学习笔记">Unpack &amp;&amp; Objection学习笔记</a><time datetime="2022-07-19T07:30:10.000Z" title="发表于 2022-07-19 15:30:10">2022-07-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/06/%E8%B7%A8%E9%93%BE%E8%AE%BA%E6%96%87-IOTJ2021/" title="跨链论文-IOTJ2021"><img src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="跨链论文-IOTJ2021"/></a><div class="content"><a class="title" href="/2022/06/06/%E8%B7%A8%E9%93%BE%E8%AE%BA%E6%96%87-IOTJ2021/" title="跨链论文-IOTJ2021">跨链论文-IOTJ2021</a><time datetime="2022-06-06T08:43:02.000Z" title="发表于 2022-06-06 16:43:02">2022-06-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/06/NEAR-subgraph-tutorial/" title="NEAR subgraph tutorial"><img src="https://hackmd.summershrimp.com/uploads/upload_08bfa2cc52f2471ea80a04d6788087db.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="NEAR subgraph tutorial"/></a><div class="content"><a class="title" href="/2022/06/06/NEAR-subgraph-tutorial/" title="NEAR subgraph tutorial">NEAR subgraph tutorial</a><time datetime="2022-06-06T06:52:36.000Z" title="发表于 2022-06-06 14:52:36">2022-06-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Dispa1r</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>